<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2025 RSL Weekly Triple Winner Report</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .dropdown-container {
      text-align: center;
      margin-bottom: 8px;
      font-size: 0.7em;
    }

    .dropdown-box {
      display: inline-block;
      margin: 0 4px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    select {
      padding: 3px 6px;
      font-size: 0.7em;
      border-radius: 4px;
    }

    button {
      padding: 4px 8px;
      font-size: 0.7em;
      border-radius: 4px;
      background-color: #0156B3;
      color: white;
      border: none;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }

    th, td {
      padding: 6px 10px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
    }

    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 0;
      z-index: 1;
      cursor: pointer;
    }

    th.sortable::after {
      content: ' â‡…';
      font-size: 0.68em;
      color: #666;
    }

    .row-group-even {
      background-color: #ffffff;
    }

    .row-group-odd {
      background-color: #f0f0f0;
    }

    .error {
      color: red;
      text-align: center;
      margin-top: 20px;
    }

    th:nth-child(1), td:nth-child(1) { max-width: 140px; }
    th:nth-child(2), td:nth-child(2) { max-width: 25px; text-align: center; }
    th:nth-child(3), td:nth-child(3) { max-width: 100px; }
    th:nth-child(4), td:nth-child(4) { max-width: 130px; }
    th:nth-child(5), td:nth-child(5) { max-width: 70px; text-align: center; }
    th:nth-child(6), td:nth-child(6) { max-width: 50px; }
    th:nth-child(7), td:nth-child(7) { max-width: 185px; }

    td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>2025 RSL Weekly Triple Winner Report</h1>

  <div class="dropdown-container">
    <div class="dropdown-box">
      <label for="weekSelect">Select Week:</label>
      <select id="weekSelect">
        <option value="all">All Weeks</option>
        <option value="2025resultsweek01.json">Week #1 (06/08/2025)</option>
        <option value="2025resultsweek02.json">Week #2 (06/15/2025)</option>
      </select>
    </div>

    <div class="dropdown-box">
      <label for="meetDateSelect">Select Meet Date:</label>
      <select id="meetDateSelect">
        <option value="all">All Dates</option>
      </select>
    </div>

    <div class="dropdown-box">
      <label for="divisionSelect">Select Division:</label>
      <select id="divisionSelect">
        <option value="all">All Divisions</option>
      </select>
    </div>

    <div class="dropdown-box">
      <label for="teamSelect">Select Team:</label>
      <select id="teamSelect">
        <option value="all">All Teams</option>
      </select>
    </div>

    <div class="dropdown-box">
      <label for="meetNameSelect">Select Meet:</label>
      <select id="meetNameSelect">
        <option value="all">All Meets</option>
      </select>
    </div>
  </div>

  <div style="text-align: center; margin-top: 10px;">
    <button onclick="downloadCSV()" style="background-color: #08b211; padding: 6px 14px; font-size: 0.9em; border-radius: 6px; color: white; border: none; cursor: pointer; margin-right: 10px;">Download CSV</button>
    <button onclick="printPage()" style="background-color: #08b211; padding: 6px 14px; font-size: 0.9em; border-radius: 6px; color: white; border: none; cursor: pointer; margin-right: 10px;">Print PDF</button>
    <button onclick="clearFilters()" style="padding: 6px 14px; font-size: 0.9em; border-radius: 6px; background-color: #0156B3; color: white; border: none; cursor: pointer;">Clear Filters</button>
  </div>

  <div id="table-container">
    <p class="error" id="error-message" style="display:none;">
      Could not load results. Please check back later.
    </p>
  </div>

<script>
    const weekSelect = document.getElementById('weekSelect');
    const dateSelect = document.getElementById('meetDateSelect');
    const meetSelect = document.getElementById('meetNameSelect');
    const divisionSelect = document.getElementById('divisionSelect');
    const teamSelect = document.getElementById('teamSelect');
    let fullData = []; // This will hold the data currently being displayed/filtered
    let rawWeekData = []; // This will hold the raw data for the selected week (or all weeks) to populate dependent dropdowns
    let currentSort = { index: null, direction: 1 };

    const teamDivisionMap = {
      "Massad YMCA": "Battlefield",
      "Hampton Oaks": "Battlefield",
      "Woodlands": "Battlefield",
      "Fawn Lake": "Battlefield",
      "Spotswood": "Battlefield",
      "Curtis Park": "Battlefield",
      "Leeland Station": "Patriot",
      "Austin Ridge": "Patriot",
      "Lake of the Woods": "Patriot",
      "Lee's Hill": "Patriot",
      "Aquia Harbour": "Patriot",
      "Dahlgren": "Patriot",
      "Fox Point": "Patriot",
      "Fredericksburg CC": "American",
      "Ferry Farm": "American",
      "Chancellor": "American",
      "Hopyard": "American",
      "Caroline": "American",
      "Spotsy Y": "American",
      "Grafton": "National",
      "College Heights": "National",
      "Salem Fields": "National",
      "Lake Wilderness": "National",
      "Eden Estates": "National",
      "Idlewild": "National"
    };

    const weekFiles = [
      "2025resultsweek01.json",
      "2025resultsweek02.json"
    ];

    function loadWeek(fileName) {
      document.getElementById('error-message').style.display = 'none'; // Hide error message on new load
      if (fileName === "all") {
        Promise.allSettled(weekFiles.map(file => fetch(file).then(r => r.ok ? r.json() : { values: [] })))
          .then(results => {
            rawWeekData = results.flatMap(r => r.value?.values || []);
            fullData = rawWeekData; // When "All Weeks", fullData is rawWeekData
            afterDataLoad();
          })
          .catch(error => {
            console.error('Error loading all JSON files:', error);
            document.getElementById('table-container').innerHTML = '';
            document.getElementById('error-message').style.display = 'block';
          });
      } else {
        fetch(fileName)
          .then(response => {
            if (!response.ok) throw new Error('Failed to fetch ' + fileName);
            return response.json();
          })
          .then(data => {
            rawWeekData = data.values;
            fullData = rawWeekData; // When a specific week, fullData is just that week's data
            afterDataLoad();
          })
          .catch(error => {
            console.error('Error loading JSON:', error);
            document.getElementById('table-container').innerHTML = '';
            document.getElementById('error-message').style.display = 'block';
          });
      }
    }

    function afterDataLoad() {
      currentSort = { index: null, direction: 1 }; // Reset sort when new data loads

      // Reset all other dropdowns to "All"
      dateSelect.value = 'all';
      meetSelect.value = 'all';
      divisionSelect.value = 'all';
      teamSelect.value = 'all';

      // Repopulate dropdowns based on the newly loaded rawWeekData
      populateDateDropdown(rawWeekData);
      populateMeetDropdown(rawWeekData); // Pass rawWeekData here to get all meets for the selected week
      populateDivisionDropdown(rawWeekData);
      populateTeamDropdown(rawWeekData);

      // Render the table with the fullData (which is now either all weeks or a single week)
      renderTable();
    }

    function populateDateDropdown(data) {
      const uniqueDates = [...new Set(data.map(row => row[5]))].sort((a, b) => new Date(a) - new Date(b)); // Sort dates
      dateSelect.innerHTML = '<option value="all">All Dates</option>'; // Always include "All Dates"
      uniqueDates.forEach(date => {
        const opt = document.createElement('option');
        opt.value = date;
        // Format the date for display (e.g., "Jun 08")
        const dateObj = new Date(date);
        if (!isNaN(dateObj)) {
          const options = { month: 'short', day: '2-digit' };
          opt.textContent = dateObj.toLocaleDateString('en-US', options);
        } else {
          opt.textContent = date; // Fallback if date is not valid
        }
        dateSelect.appendChild(opt);
      });
    }

    function populateMeetDropdown(data) {
      const selectedDate = dateSelect.value;
      // If a specific date is selected, filter by that date before getting unique meets
      const filteredByDate = selectedDate === "all" ? data : data.filter(r => r[5] === selectedDate);
      const uniqueMeets = [...new Set(filteredByDate.map(row => row[6]))].sort();
      meetSelect.innerHTML = '<option value="all">All Meets</option>';
      uniqueMeets.forEach(meet => {
        const opt = document.createElement('option');
        opt.value = meet;
        opt.textContent = meet;
        meetSelect.appendChild(opt);
      });
    }

    function populateDivisionDropdown(data) {
      const uniqueDivisions = [...new Set(data.map(row => teamDivisionMap[row[2]]).filter(Boolean))].sort();
      divisionSelect.innerHTML = '<option value="all">All Divisions</option>'; // Always include "All Divisions"
      uniqueDivisions.forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        divisionSelect.appendChild(opt);
      });
    }

    function populateTeamDropdown(data) {
      const uniqueTeams = [...new Set(data.map(row => row[2]))].sort();
      teamSelect.innerHTML = '<option value="all">All Teams</option>'; // Always include "All Teams"
      uniqueTeams.forEach(team => {
        const opt = document.createElement('option');
        opt.value = team;
        opt.textContent = team;
        teamSelect.appendChild(opt);
      });
    }

    function renderTable() {
      let filtered = [...fullData]; // Start filtering from the currently loaded data (all weeks or single week)

      if (dateSelect.value !== 'all') filtered = filtered.filter(row => row[5] === dateSelect.value);
      if (meetSelect.value !== 'all') filtered = filtered.filter(row => row[6] === meetSelect.value);
      if (divisionSelect.value !== 'all') filtered = filtered.filter(row => teamDivisionMap[row[2]] === divisionSelect.value);
      if (teamSelect.value !== 'all') filtered = filtered.filter(row => row[2] === teamSelect.value);

      if (currentSort.index !== null) {
        filtered.sort((a, b) => {
          const valA = a[currentSort.index];
          const valB = b[currentSort.index];

          // Special handling for date column (index 5) for proper sorting
          if (currentSort.index === 5) {
            const dateA = new Date(valA);
            const dateB = new Date(valB);
            return currentSort.direction * (dateA - dateB);
          }

          return typeof valA === 'number'
            ? currentSort.direction * (valA - valB)
            : currentSort.direction * String(valA).localeCompare(String(valB)); // Ensure string comparison for non-numbers
        });
      }

      const grouped = {};
      filtered.forEach(row => {
        const key = row[0]; // Group by Athlete Name
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(row);
      });

      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const headers = ["Athlete Name", "Age", "Team Name", "Event", "Time", "Meet Date", "Meet Name"];
      const sortableCols = [0, 1, 2, 5]; // Added Meet Date (index 5) to sortable columns
      const headerRow = document.createElement('tr');

      headers.forEach((h, i) => {
        const th = document.createElement('th');
        th.textContent = h;
        if (sortableCols.includes(i)) {
          th.classList.add('sortable');
          th.addEventListener('click', () => {
            if (currentSort.index === i) {
              currentSort.direction *= -1;
            } else {
              currentSort.index = i;
              currentSort.direction = 1;
            }
            renderTable(); // Re-render table after sorting
          });
        }
        headerRow.appendChild(th);
      });

      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      let groupIndex = 0;
      for (const group of Object.values(grouped)) {
        const cssClass = groupIndex % 2 === 0 ? 'row-group-even' : 'row-group-odd';
        group.forEach((row, i) => {
          const tr = document.createElement('tr');
          tr.className = cssClass;
          row.forEach((cell, colIndex) => {
            const td = document.createElement('td');
            let displayValue = cell;
            if (colIndex === 5 && typeof cell === 'string') {
              const dateObj = new Date(cell);
              if (!isNaN(dateObj)) {
                const options = { month: 'short', day: '2-digit' };
                displayValue = dateObj.toLocaleDateString('en-US', options);
              }
            }
            td.innerHTML = (i === 0 && colIndex === 0) ? `<strong>${displayValue}</strong>` :
                           (i !== 0 && colIndex < 3) ? '' : displayValue;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        groupIndex++;
      }

      document.getElementById('table-container').innerHTML = '';
      document.getElementById('table-container').appendChild(table);
    }

    weekSelect.addEventListener('change', () => loadWeek(weekSelect.value));
    dateSelect.addEventListener('change', () => {
      // When date changes, only re-populate meet dropdown based on the selected date
      populateMeetDropdown(rawWeekData);
      meetSelect.value = 'all'; // Reset meet filter when date changes
      renderTable();
    });
    meetSelect.addEventListener('change', () => renderTable());
    divisionSelect.addEventListener('change', () => renderTable());
    teamSelect.addEventListener('change', () => renderTable());

    function clearFilters() {
      weekSelect.value = 'all';
      loadWeek('all'); // Reload all data when filters are cleared
    }

    function downloadCSV() {
      const rows = Array.from(document.querySelectorAll("#table-container table tr"));
      const csvContent = rows.map(row =>
        Array.from(row.querySelectorAll("th, td")).map(cell => '"' + cell.textContent.replace(/"/g, '""') + '"').join(",")
      ).join("\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.setAttribute("href", URL.createObjectURL(blob));
      link.setAttribute("download", "TripleWinners.csv");
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function printPage() {
      window.print();
    }

    // Initial load when the page loads
    loadWeek('all');
  </script>
</body>
</html>
