<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2025 RSL Meet Scores</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f8f8f8;
      color: #333;
    }

    h1 {
      text-align: center;
      color: #0156B3;
      font-size: 2em;
      margin-bottom: 10px;
    }

    .dropdown-container {
      position: sticky;
      top: 0;
      background-color: #f8f8f8;
      padding: 10px;
      text-align: center;
      z-index: 10;
      border-bottom: 1px solid #ccc;
      font-size: 0.7em;
    }

    .dropdown-box {
      display: inline-block;
      margin: 0 4px;
    }

    label {
      font-weight: bold;
      display: block;
      margin-bottom: 6px;
    }

    .label {
  color: #888;
  font-style: italic;
  font-size: 0.85em;
}

    select {
      padding: 3px 6px;
      font-size: 0.7em;
      border-radius: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.68em;
      margin-top: 10px;
    }

th, td {
  padding: 6px 10px;
  border: 1px solid #ccc;
  text-align: center;
  vertical-align: middle;
}

    th {
      background-color: #e5f1ff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .winner {
      font-weight: bold;
      color: green;
    }

    .check {
      font-size: 1em;
      margin-left: 4px;
    }

    .meet-name {
      font-style: italic;
      color: #666;
    }

    .button-bar {
      text-align: center;
      margin-top: 10px;
    }

    .button-bar button {
      padding: 6px 14px;
      font-size: 0.9em;
      border-radius: 6px;
      color: white;
      border: none;
      cursor: pointer;
      margin-right: 10px;
    }

    .csv-btn, .print-btn {
      background-color: #08b211;
    }

    .clear-btn {
      background-color: #0156B3;
    }
  </style>
</head>
<body>

<h1>2025 RSL Meet Scores</h1>

<div class="dropdown-container">
  <div class="dropdown-box">
    <label for="weekSelect">Week</label>
    <select id="weekSelect" onchange="loadWeekData(this.value)">
      <!-- Week options populated dynamically -->
    </select>
  </div>
  <div class="dropdown-box">
    <label for="divisionSelect">Division</label>
    <select id="divisionSelect" onchange="filterDivision()">
      <option value="all">All Divisions</option>
    </select>
  </div>
</div>

<div class="button-bar">
  <button class="csv-btn" onclick="downloadCSV()">Download CSV</button>
  <button class="print-btn" onclick="printPage()">Print PDF</button>
  <button class="clear-btn" onclick="clearFilters()">Clear Filters</button>
</div>

<table id="scoresTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Meet</th>
      <th>Score</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  const weekFiles = [
    "2025scoresweek01.json",
    "2025scoresweek02.json"
    // Add more weeks as needed
  ];

  const teamDivisionMap = {
    "Massad YMCA": "Battlefield",
    "Hampton Oaks": "Battlefield",
    "Woodlands": "Battlefield",
    "Fawn Lake": "Battlefield",
    "Spotswood": "Battlefield",
    "Curtis Park": "Battlefield",
    "Leeland Station": "Patriot",
    "Austin Ridge": "Patriot",
    "Lake of the Woods": "Patriot",
    "Lee's Hill": "Patriot",
    "Aquia Harbour": "Patriot",
    "Dahlgren": "Patriot",
    "Fox Point": "Patriot",
    "Fredericksburg CC": "American",
    "Ferry Farm": "American",
    "Chancellor": "American",
    "Hopyard": "American",
    "Caroline": "American",
    "Spotsy Y": "American",
    "Grafton": "National",
    "College Heights": "National",
    "Salem Fields": "National",
    "Lake Wilderness": "National",
    "Eden Estates": "National",
    "Idlewild": "National"
  };

  let allRows = [];

  function getDivision(team1, team2) {
    const d1 = teamDivisionMap[team1];
    const d2 = teamDivisionMap[team2];
    if (d1 && d2) {
      return d1 === d2 ? d1 : "Mixed";
    }
    return d1 || d2 || "Unknown";
  }

  function populateWeekDropdown() {
    const dropdown = document.getElementById("weekSelect");
    weekFiles.forEach((file, idx) => {
      const weekNum = idx + 1;
      const option = document.createElement("option");
      option.value = file;
      option.text = `Week #${weekNum}`;
      dropdown.appendChild(option);
    });
  }

  function populateDivisionDropdown(rows) {
    const divisions = [...new Set(rows.map(row => row.division))];
    const divisionSelect = document.getElementById("divisionSelect");
    divisionSelect.innerHTML = `<option value="all">All Divisions</option>`;
    divisions.forEach(div => {
      const opt = document.createElement("option");
      opt.value = div;
      opt.text = div;
      divisionSelect.appendChild(opt);
    });
  }

function loadWeekData(file) {
  fetch(file)
    .then(res => res.json())
    .then(data => {
      const merged = new Map();

      data.values.forEach(row => {
        const [date, meetName, teamA, scoreA, teamB, scoreB] = row;
        const key = `${meetName}|${date}`;

        if (!merged.has(key)) {
          merged.set(key, {
            date,
            meetName,
            teams: {} // key: team name, value: score
          });
        }

        const match = merged.get(key);

        if (teamA && scoreA != null) {
          match.teams[teamA] = scoreA;
        }
        if (teamB && scoreB != null) {
          match.teams[teamB] = scoreB;
        }
      });

      allRows = [];

      merged.forEach((m) => {
        const teamNames = Object.keys(m.teams);
        if (teamNames.length !== 2) return; // skip if incomplete

        const team1 = teamNames[0];
        const team2 = teamNames[1];
        const score1 = m.teams[team1];
        const score2 = m.teams[team2];

        allRows.push({
          division: getDivision(team1, team2),
          data: [m.date, m.meetName, team1, score1, team2, score2]
        });
      });

      populateDivisionDropdown(allRows);
      renderScores(allRows);
    })
    .catch(err => {
      console.error("Failed to load JSON:", err);
      document.querySelector("#scoresTable tbody").innerHTML = "<tr><td colspan='3'>Unable to load data.</td></tr>";
    });
}

function renderScores(rows) {
  const tbody = document.querySelector("#scoresTable tbody");
  tbody.innerHTML = "";

  rows.forEach(({ data }) => {
    const [date, meetName, homeTeam, homeScore, awayTeam, awayScore] = data;

    const sHome = homeScore != null ? parseFloat(homeScore) : 0;
    const sAway = awayScore != null ? parseFloat(awayScore) : 0;

    const homeIsWinner = sHome > sAway;
    const awayIsWinner = sAway > sHome;

    const awayContent = `✅ ${awayTeam} ${sAway}`;
    const homeContent = `${sHome} ${homeTeam} ✅`;

    const awayBlock = awayIsWinner
      ? `<span class="winner"><span class="label">(Away)</span> ${awayContent}</span>`
      : `<span><span class="label">(Away)</span> ${awayTeam} ${sAway}</span>`;

    const homeBlock = homeIsWinner
      ? `<span class="winner">✅ ${sHome} ${homeTeam} <span class="label">(Home)</span></span>`
      : `<span>${sHome} ${homeTeam} <span class="label">(Home)</span></span>`;

    const scoreDisplay = `${awayBlock} — ${homeBlock}`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${date}</td>
      <td class="meet-name">${meetName}</td>
      <td>${scoreDisplay}</td>
    `;
    tbody.appendChild(tr);
  });
}

  function filterDivision() {
    const selected = document.getElementById("divisionSelect").value;
    const filtered = selected === "all" ? allRows : allRows.filter(r => r.division === selected);
    renderScores(filtered);
  }

  function clearFilters() {
    document.getElementById("divisionSelect").value = "all";
    renderScores(allRows);
  }

  function printPage() {
    window.print();
  }

  function downloadCSV() {
    const headers = ["Date", "Meet", "Score"];
    const rows = [];

    const filtered = document.querySelectorAll("#scoresTable tbody tr");
    filtered.forEach(tr => {
      const cells = tr.querySelectorAll("td");
      if (cells.length === 3) {
        const date = cells[0].innerText.trim();
        const meet = cells[1].innerText.trim();
        const score = cells[2].innerText.trim().replace(/\s+/g, " ");
        rows.push([date, meet, score]);
      }
    });

    let csvContent = "data:text/csv;charset=utf-8," 
      + headers.join(",") + "\n"
      + rows.map(e => e.map(v => `"${v}"`).join(",")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "rsl_meet_scores.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Initialize
  window.onload = function () {
    populateWeekDropdown();
    const latest = weekFiles[weekFiles.length - 1];
    document.getElementById("weekSelect").value = latest;
    loadWeekData(latest);
  };
</script>

</body>
</html>
